<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Завдання - Lab8_</title>
  <link rel="icon" type="image/png" href="./favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/svg+xml" href="./favicon.svg">
  <link rel="shortcut icon" href="./favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
  <meta name="apple-mobile-web-app-title" content="Lab8_">
  <link rel="manifest" href="./site.webmanifest">
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <!-- Matrix Background -->
  <div class="matrix-bg" id="matrix-bg"></div>

  <nav>
    <div class="nav-container container">
      <div class="logo">Lab8_</div>
      <ul class="nav-links">
        <li><a href="index.html">Головна</a></li>
        <li><a href="status.html">Статус</a></li>
        <li class="active"><a href="tasks.html">Завдання</a></li>
        <li><a href="team.html">Команда</a></li>
      </ul>
    </div>
  </nav>

  <section id="tasks" class="section">
    <div class="container">
      <h2>ЗАВДАННЯ Lab8_</h2>
      <p style="text-align: center;">Моніторинг фінансових індикаторів та валютних курсів</p>

      <div class="terminal">
        > tasks --currency-rates<br>
        Fetching live exchange rates...<br>
        Data source: Quantum Financial Network<br>
        Last update: 2025-11-27 12:00 UTC
      </div>

      <div class="card" style="max-width: 1000px; margin: 0 auto;">
        <h3 style="color: #00ffff; text-align: center;">КУРСИ ВАЛЮТ</h3>
        <p style="text-align: center; color: #b8c5d6; margin-bottom: 2rem;">
          Поточні курси валют відносно Української гривні (UAH)
        </p>

        <div style="text-align: center; margin-bottom: 2rem;">
          <button id="sync-btn" class="cta-button">СИНХРОНІЗУВАТИ ДАНІ</button>
        </div>

        <table class="currency-table">
          <thead>
            <tr>
              <th>Валюта</th>
              <th>Код</th>
              <th>Курс до UAH</th>
              <th>Статус</th>
            </tr>
          </thead>
          <tbody id="currency-tbody">
            <!-- Data will be loaded dynamically -->
          </tbody>
        </table>

        <div class="terminal" style="margin-top: 2rem; text-align: left;">
          > currency.update --auto<br>
          Auto-update enabled...<br>
          Next refresh: 60 seconds<br>
          Quantum sync: ACTIVE
        </div>
      </div>

      <div class="charts-section" style="margin-top: 3rem;">
        <h3 style="color: #00ffff; text-align: center; margin-bottom: 2rem;">ГРАФІКИ ЗМІНИ КУРСІВ ВАЛЮТ</h3>

        <div class="charts-grid" style="max-width: 1000px; grid-template-columns: repeat(auto-fit, minmax(1000px, 1fr));">
          <div class="chart-card">
            <h4>USD - Долар США</h4>
            <div class="chart-controls" style="text-align: center; margin-bottom: 1rem;">
              <button class="chart-btn prev-month">◀ Попередній</button>
              <span class="current-month-display" style="color: #00ffff; margin: 0 1rem;"></span>
              <button class="chart-btn next-month">Наступний ▶</button>
            </div>
            <canvas id="usd-chart" width="400" height="200"></canvas>
          </div>
          <div class="chart-card">
            <h4>EUR - Євро</h4>
            <div class="chart-controls" style="text-align: center; margin-bottom: 1rem;">
              <button class="chart-btn prev-month">◀ Попередній</button>
              <span class="current-month-display" style="color: #00ffff; margin: 0 1rem;"></span>
              <button class="chart-btn next-month">Наступний ▶</button>
            </div>
            <canvas id="eur-chart" width="400" height="200"></canvas>
          </div>
          <div class="chart-card">
            <h4>MXN - Мексиканський песо</h4>
            <div class="chart-controls" style="text-align: center; margin-bottom: 1rem;">
              <button class="chart-btn prev-month">◀ Попередній</button>
              <span class="current-month-display" style="color: #00ffff; margin: 0 1rem;"></span>
              <button class="chart-btn next-month">Наступний ▶</button>
            </div>
            <canvas id="mxn-chart" width="400" height="200"></canvas>
          </div>
          <div class="chart-card">
            <h4>SGD - Сінгапурський долар</h4>
            <div class="chart-controls" style="text-align: center; margin-bottom: 1rem;">
              <button class="chart-btn prev-month">◀ Попередній</button>
              <span class="current-month-display" style="color: #00ffff; margin: 0 1rem;"></span>
              <button class="chart-btn next-month">Наступний ▶</button>
            </div>
            <canvas id="sgd-chart" width="400" height="200"></canvas>
          </div>
          <div class="chart-card">
            <h4>INR - Індійська рупія</h4>
            <div class="chart-controls" style="text-align: center; margin-bottom: 1rem;">
              <button class="chart-btn prev-month">◀ Попередній</button>
              <span class="current-month-display" style="color: #00ffff; margin: 0 1rem;"></span>
              <button class="chart-btn next-month">Наступний ▶</button>
            </div>
            <canvas id="inr-chart" width="400" height="200"></canvas>
          </div>
          <div class="chart-card">
            <h4>ZAR - Південноафриканський ранд</h4>
            <div class="chart-controls" style="text-align: center; margin-bottom: 1rem;">
              <button class="chart-btn prev-month">◀ Попередній</button>
              <span class="current-month-display" style="color: #00ffff; margin: 0 1rem;"></span>
              <button class="chart-btn next-month">Наступний ▶</button>
            </div>
            <canvas id="zar-chart" width="400" height="200"></canvas>
          </div>
        </div>
      </div>
    </div>
  </section>

  <script src="matrix.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let currentDate = new Date();
    let charts = {};

    async function loadChartData(valcode, startDate, endDate) {
      const url = `https://bank.gov.ua/NBU_Exchange/exchange_site?start=${startDate}&end=${endDate}&valcode=${valcode}&sort=exchangedate&order=asc&json`;
      const proxyUrl = `https://media-design.kiev.ua/cors.php?url=${encodeURIComponent(url)}`;
      const response = await fetch(proxyUrl);
      const data = await response.json();
      return data.map(item => ({
        // date: item.exchangedate,
        date: item.exchangedate.slice(0, 5),
        rate: item.rate
      }));
    }

    function createChart(canvasId, data, label) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      if (charts[canvasId]) {
        charts[canvasId].destroy();
      }
      charts[canvasId] = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.map(d => d.date),
          datasets: [{
            label: label,
            data: data.map(d => d.rate),
            borderColor: '#00ffff',
            backgroundColor: 'rgba(0, 255, 255, 0.1)',
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            x: {
              grid: {
                color: 'rgba(0, 255, 255, 0.2)'
              },
              ticks: {
                color: '#00ffff',
                maxTicksLimit: 10,
              }
            },
            y: {
              grid: {
                color: 'rgba(0, 255, 255, 0.2)'
              },
              ticks: {
                color: '#00ffff',
                maxTicksLimit: 8,
              }
            }
          }
        }
      });
    }

    async function updateCharts() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth() + 1;
      const startDate = `${year}${month.toString().padStart(2, '0')}01`;
      const endDate = `${year}${month.toString().padStart(2, '0')}${new Date(year, month, 0).getDate()}`;

      const monthDisplays = document.querySelectorAll('.current-month-display');
      monthDisplays.forEach(display => {
        display.textContent = currentDate.toLocaleDateString('uk-UA', { year: 'numeric', month: 'long' });
      });

      const currencies = [
        { code: 'usd', id: 'usd-chart', name: 'USD' },
        { code: 'eur', id: 'eur-chart', name: 'EUR' },
        { code: 'mxn', id: 'mxn-chart', name: 'MXN' },
        { code: 'sgd', id: 'sgd-chart', name: 'SGD' },
        { code: 'inr', id: 'inr-chart', name: 'INR' },
        { code: 'zar', id: 'zar-chart', name: 'ZAR' }
      ];

      for (const currency of currencies) {
        try {
          const data = await loadChartData(currency.code, startDate, endDate);
          createChart(currency.id, data, `${currency.name} до UAH`);
        } catch (error) {
          console.error(`Error loading ${currency.code}:`, error);
        }
      }
    }

    async function loadCurrencyRates() {
      const btn = document.getElementById('sync-btn');
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'СИНХРОНІЗАЦІЯ...';
      }

      try {
        const response = await fetch('https://bank.gov.ua/NBUStatService/v1/statdirectory/exchange?json');
        const data = await response.json();

        const tbody = document.getElementById('currency-tbody');
        tbody.innerHTML = '';

        data.forEach(currency => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${currency.txt}</td>
            <td>${currency.cc}</td>
            <td>${currency.rate.toFixed(4)}</td>
            <td><span class="status-active">АКТИВНИЙ</span></td>
          `;
          tbody.appendChild(row);
        });

        // Update the terminal message with current date and time
        const terminal = document.querySelector('.terminal');
        if (terminal) {
          const now = new Date();
          const dateTime = now.toLocaleString('uk-UA', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
          });
          terminal.innerHTML = terminal.innerHTML.replace(/Last update: .*/, `Last update: ${dateTime}`);
        }
      } catch (error) {
        console.error('Error loading currency rates:', error);
        // Fallback to some message
        const tbody = document.getElementById('currency-tbody');
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #ff0000;">Помилка завантаження даних</td></tr>';
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'СИНХРОНІЗУВАТИ ДАНІ';
        }
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadCurrencyRates();

      const syncBtn = document.getElementById('sync-btn');
      if (syncBtn) {
        syncBtn.addEventListener('click', loadCurrencyRates);
      }

      updateCharts();

      document.querySelectorAll('.prev-month').forEach(btn => {
        btn.addEventListener('click', () => {
          currentDate.setMonth(currentDate.getMonth() - 1);
          updateCharts();
        });
      });

      document.querySelectorAll('.next-month').forEach(btn => {
        btn.addEventListener('click', () => {
          currentDate.setMonth(currentDate.getMonth() + 1);
          updateCharts();
        });
      });
    });
  </script>
</body>
</html>
